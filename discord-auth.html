<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Discord Login</title>
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>

<body class="auth-page">
  <div class="auth-box">
    <h2>Accesso in corso...</h2>
    <p class="muted">Sto completando il login con Discord.</p>
  </div>

  <script>
    const code = new URLSearchParams(window.location.search).get("code");

    if (!code) {
      document.body.innerHTML = "<div class='auth-box'><h2>Errore: nessun codice OAuth ricevuto.</h2></div>";
      throw new Error("Missing OAuth code");
    }

    fetch("https://api.vitriotv.com/discord/token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.access_token) {
        document.body.innerHTML = "<div class='auth-box'><h2>Errore nel token exchange.</h2></div>";
        console.error(data);
        return;
      }

      localStorage.setItem("discord_access_token", data.access_token);
      window.location.href = "index.html";
    })
    .catch(err => {
      document.body.innerHTML = "<div class='auth-box'><h2>Errore durante la comunicazione con il backend.</h2></div>";
      console.error(err);
    });
  </script>
</body>
</html>
